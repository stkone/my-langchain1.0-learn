# LangChain 1.0 æ ·ä¾‹è§£æï¼šç”µå•†å®¢æˆ·åé¦ˆå¤„ç†ç³»ç»Ÿ

> æœ¬æ–‡åŸºäº `01_project_demo1.py` ä»£ç ï¼Œä¸ºæ–°æ‰‹æä¾› LangChain 1.0 å®æˆ˜è§£æã€‚æˆ‘ä»¬å°†ä»**æ ¸å¿ƒæ¦‚å¿µâ†’ä»£ç ç»“æ„â†’ç”Ÿäº§å®è·µ**å±‚å±‚é€’è¿›ï¼Œå¸®åŠ©ä½ å¿«é€ŸæŒæ¡ LangChain 1.0 çš„ç²¾é«“ã€‚

---

## ä¸€ã€LangChain 1.0 æ ¸å¿ƒæ¦‚å¿µï¼ˆæ–°æ‰‹å¿…è¯»ï¼‰

åœ¨æ·±å…¥ä»£ç å‰ï¼Œå…ˆç†è§£ LangChain 1.0 çš„**ä¸‰å¤§åŸºçŸ³**ï¼š


| æ¦‚å¿µ             | ä½œç”¨                     | ç±»æ¯”     | ä»£ç ä½“ç°                             |
| ---------------- | ------------------------ | -------- | ------------------------------------ |
| **Runnable**     | æ‰§è¡Œå•å…ƒï¼ˆå‡½æ•°/é“¾/æ¨¡å‹ï¼‰ | é›¶ä»¶     | `RunnableParallel`, `RunnableLambda` |
| **Chain**        | ä¸²è” Runnable çš„æµç¨‹     | ç”Ÿäº§çº¿   | `processing_chain`                   |
| **OutputParser** | æ ¼å¼åŒ–è¾“å‡º               | äº§å“è´¨æ£€ | `JsonOutputParser`                   |

> ğŸ’¡ **å…³é”®åŒºåˆ«**ï¼šLangChain 1.0 ç”¨ **`Runnable` ä»£æ›¿ `Chain`**ï¼Œå¼ºè°ƒ**å¯ç»„åˆæ€§**ï¼ˆç±»ä¼¼ä¹é«˜ç§¯æœ¨ï¼‰

---

## äºŒã€ä»£ç ç»“æ„æ·±åº¦è§£æ

### 1. æ ¸å¿ƒæµç¨‹å›¾è§£

```mermaid
graph LR
A[ç”¨æˆ·è¾“å…¥] --> B(æå–è®¢å•ID)
A --> C(æƒ…æ„Ÿåˆ†æ)
A --> D(é—®é¢˜åˆ†ç±»)
A --> E(ç´§æ€¥ç¨‹åº¦è¯„ä¼°)
B & C & D & E --> F[ç”Ÿæˆå›å¤]
```

### 2. æ¨¡å—åŒ–ä»£ç æ‹†è§£ï¼ˆæŒ‰åŠŸèƒ½å±‚çº§ï¼‰

#### âœ… æ¨¡å— 1ï¼šè®¢å•IDæå–ï¼ˆ`extract_order_id`ï¼‰

```python
def extract_order_id(user_input: str) -> dict:
    prompt = f"ä½ æ˜¯ä¸€ä¸ªç”µå•†è®¢å•å¤„ç†ä¸“å®¶ï¼Œè¯·ä»ä»¥ä¸‹å®¢æˆ·åé¦ˆä¸­æå–è®¢å•IDï¼š{user_input}"
    # ä¼˜å…ˆä½¿ç”¨æ­£åˆ™ï¼ˆé«˜æ•ˆï¼‰
    match = re.search(r'ORD\d{10}', user_input)
    return {"order_id": match.group(0) if match else "NOT_FOUND"}
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

- ä¼˜å…ˆç”¨**æ­£åˆ™**ï¼ˆç®€å•é«˜æ•ˆï¼‰â†’ 90%åœºæ™¯æ— éœ€è°ƒç”¨æ¨¡å‹
- ä»…å½“æ­£åˆ™å¤±è´¥æ—¶ï¼Œ**å›é€€åˆ°æ¨¡å‹**ï¼ˆé¿å…èµ„æºæµªè´¹ï¼‰
- **ç”Ÿäº§å®è·µ**ï¼š`re` æ˜¯å¤„ç†ç»“æ„åŒ–æ•°æ®çš„é¦–é€‰ï¼Œæ¯”æ¨¡å‹æ›´å¯é 

---

#### âœ… æ¨¡å— 2ï¼šæƒ…æ„Ÿåˆ†æï¼ˆ`analyze_sentiment`ï¼‰

```python
def analyze_sentiment(user_input: str) -> dict:
    prompt = f"è¯·åˆ†æä»¥ä¸‹å®¢æˆ·åé¦ˆçš„æƒ…æ„Ÿå€¾å‘ï¼šã€Œ{user_input}ã€"
    # å¼ºåˆ¶è¦æ±‚JSONæ ¼å¼
    result = call_qwen_with_retry(prompt)
    return JsonOutputParser().parse(result)
```

**å…³é”®è®¾è®¡ç‚¹ï¼š**

1. **è¾“å‡ºçº¦æŸ**ï¼š`è¿”å›JSONæ ¼å¼` â†’ é¿å…æ¨¡å‹è¾“å‡ºä¹±ç 
2. **ç½®ä¿¡åº¦**ï¼š`confidence` å­—æ®µ â†’ ä¸ºåç»­é€»è¾‘æä¾›ä¾æ®
3. **å…³é”®çŸ­è¯­**ï¼š`key_phrases` â†’ ç”¨äºç”Ÿæˆå›å¤æ—¶çš„ä¸ªæ€§åŒ–

> ğŸŒŸ **æ–°æ‰‹æŠ€å·§**ï¼šæ°¸è¿œåœ¨ prompt ä¸­è¦æ±‚ **`JSONæ ¼å¼`**ï¼Œé¿å…è§£æå¤±è´¥

---

#### âœ… æ¨¡å— 3ï¼šé—®é¢˜åˆ†ç±»ï¼ˆ`classify_issue`ï¼‰

```python
def classify_issue(user_input: str) -> dict:
    prompt = f"ä½œä¸ºç”µå•†å®¢æœä¸“å®¶ï¼Œè¯·å¯¹ä»¥ä¸‹å®¢æˆ·åé¦ˆè¿›è¡Œåˆ†ç±»ï¼šã€Œ{user_input}ã€"
    # é™å®šåˆ†ç±»é€‰é¡¹ï¼ˆé¿å…æ¨¡å‹å‘æ•£ï¼‰
    categories = ["ç‰©æµé—®é¢˜", "äº§å“è´¨é‡", ...]
    # è¿”å›æœ€ç›¸å…³çš„1-2ä¸ª
    return {"categories": ["ç‰©æµé—®é¢˜", "æ”¯ä»˜é—®é¢˜"]}
```

**ä¸ºä»€ä¹ˆè¿™æ ·å†™ï¼Ÿ**

- **é¢„å®šä¹‰é€‰é¡¹**ï¼šå‡å°‘æ¨¡å‹è¾“å‡ºä¸ç¡®å®šæ€§
- **ç›¸å…³æ€§æ’åº**ï¼š`æŒ‰ç›¸å…³æ€§æ’åº` â†’ ä¿è¯ç»“æœå¯ç”¨æ€§
- **ç”Ÿäº§ä»·å€¼**ï¼šç›´æ¥å…³è”å®¢æœå·¥å•ç³»ç»Ÿ

---

#### âœ… æ¨¡å— 4ï¼šç´§æ€¥ç¨‹åº¦è¯„ä¼°ï¼ˆ`assess_priority`ï¼‰

```python
def assess_priority(user_input: str) -> dict:
    prompt = f"ä½œä¸ºå®¢æœä¸»ç®¡ï¼Œè¯·è¯„ä¼°ä»¥ä¸‹å®¢æˆ·åé¦ˆçš„ç´§æ€¥ç¨‹åº¦ï¼šã€Œ{user_input}ã€"
    # æ˜ç¡®å®šä¹‰æ ‡å‡†
    return {
        "urgency": "HIGH",
        "sla_hours": 24,
        "reason": "åŒ…å«'ç«‹åˆ»'å…³é”®è¯"
    }
```

**æ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼š**

- **SLAï¼ˆæœåŠ¡ç­‰çº§åè®®ï¼‰**ï¼š`sla_hours` â†’ ç›´æ¥å¯¹æ¥å®¢æœç³»ç»Ÿ
- **ç†ç”±å­—æ®µ**ï¼š`reason` â†’ ç”¨äºäººå·¥å¤æ ¸

---

#### âœ… æ¨¡å— 5ï¼šå›å¤ç”Ÿæˆï¼ˆ`generate_reply`ï¼‰

```python
def generate_reply(data: dict) -> str:
    prompt = f"""ä½ æ˜¯ä¸€åèµ„æ·±ç”µå•†å®¢æœä¸“å®¶ï¼Œè¯·æ ¹æ®ä»¥ä¸‹åˆ†æç»“æœç”Ÿæˆå®¢æˆ·å›å¤ï¼š
    ### åˆ†æç»“æœï¼š
    - è®¢å•IDï¼š{data["order_id"]}
    - æƒ…æ„Ÿå€¾å‘ï¼š{data["sentiment"]} (ç½®ä¿¡åº¦ï¼š{data["confidence"]:.2f})
    - é—®é¢˜ç±»å‹ï¼š{data["categories"]}
    - ç´§æ€¥ç¨‹åº¦ï¼š{data["urgency"]} (éœ€åœ¨{data["sla_hours"]}å°æ—¶å†…å“åº”)
    {key_phrases_section}
    ### å›å¤è¦æ±‚ï¼š
    1. æ ¹æ®æƒ…æ„Ÿå€¾å‘è°ƒæ•´è¯­æ°”...
    """
    return call_qwen_with_retry(prompt)
```

**é«˜ä»·å€¼è®¾è®¡ï¼š**

- **åŠ¨æ€æ¨¡æ¿**ï¼šå°†åˆ†æç»“æœæ³¨å…¥ prompt â†’ ç¡®ä¿å›å¤ç²¾å‡†
- **çº¦æŸæ¡ä»¶**ï¼š`é•¿åº¦100-150å­—`ã€`è‡ªç„¶å£è¯­` â†’ é¿å…ç”Ÿæˆå†—é•¿å†…å®¹

---

### 3. é“¾å¼å¤„ç†æ ¸å¿ƒï¼ˆ`processing_chain`ï¼‰

```python
processing_chain = (
    RunnablePassthrough.assign(analysis=lambda x: analysis_chain.invoke(x))
    | {
        "order_id": lambda x: x["analysis"]["order_id"]["order_id"],
        "sentiment": lambda x: x["analysis"]["sentiment"]["sentiment"],
        # ...å…¶ä»–å­—æ®µ
    }
    | RunnableLambda(generate_reply)
)
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

- **å¹¶è¡Œæ‰§è¡Œ**ï¼š`analysis_chain` ä¸­çš„ `RunnableParallel` â†’ æƒ…æ„Ÿ/åˆ†ç±»/ä¼˜å…ˆçº§**å¹¶è¡Œå¤„ç†**
- **å­—æ®µæå–**ï¼š`lambda` å‡½æ•°ç²¾å‡†æå–åµŒå¥—ç»“æœ
- **é“¾å¼ç»„åˆ**ï¼š`|` æ“ä½œç¬¦ â†’ ä»£ç å¯è¯»æ€§æä½³

---

## ä¸‰ã€ç”Ÿäº§å®è·µå»ºè®®ï¼ˆæ–°æ‰‹å¿…çœ‹ï¼‰

### âœ… å¿…é¡»åšçš„ 5 ä»¶äº‹


| é—®é¢˜             | ä»£ç å®ç°               | ç”Ÿäº§ä»·å€¼            |
| ---------------- | ---------------------- | ------------------- |
| **æ¨¡å‹è°ƒç”¨å¤±è´¥** | `call_qwen_with_retry` | é¿å…æœåŠ¡é›ªå´©        |
| **è¾“å‡ºæ ¼å¼æ··ä¹±** | `JsonOutputParser`     | ä¿è¯ä¸‹æ¸¸ç³»ç»Ÿå¯ç”¨    |
| **èµ„æºæµªè´¹**     | ä¼˜å…ˆæ­£åˆ™ â†’ å†è°ƒæ¨¡å‹   | é™ä½ 80% API è°ƒç”¨é‡ |
| **é€»è¾‘ä¸å¯æ§**   | é¢„å®šä¹‰åˆ†ç±»é€‰é¡¹         | é¿å…æ¨¡å‹å‘æ•£        |
| **äººå·¥å¯å¤æ ¸**   | æ·»åŠ `reason` å­—æ®µ      | ä¾¿äºå®¢æœå¤ç›˜        |

### âš ï¸ éœ€è¦è­¦æƒ•çš„ 3 ä¸ªå‘

1. **`re.search` è¯¯åŒ¹é…**
   â†’ ä¿®å¤ï¼š`r'ORD\d{10}\b'`ï¼ˆæ·»åŠ å•è¯è¾¹ç•Œ `\b`ï¼‰
2. **`confidence` æœªæ ¡éªŒ**
   â†’ ä¿®å¤ï¼šæ·»åŠ  `if confidence < 0.7: return "æ¨¡å‹ç½®ä¿¡åº¦ä¸è¶³"`
3. **æœªå¤„ç† JSON è§£æå¤±è´¥**
   â†’ ä¿®å¤ï¼š`try/except` åŒ…è£¹ `JsonOutputParser.parse()`

---

## å››ã€æ–°æ‰‹å­¦ä¹ è·¯å¾„ï¼ˆå¾ªåºæ¸è¿›ï¼‰

```mermaid
graph TD
    A[åŸºç¡€] -->|1. ç†è§£ Runnable| B[ç®€å•é“¾]
    B -->|2. ç”¨ RunnableParallel å¹¶è¡Œ| C[å¤æ‚é“¾]
    C -->|3. ç”¨ JsonOutputParser ç¡®ä¿æ ¼å¼| D[ç”Ÿäº§çº§ä»£ç ]
    D -->|4. æ·»åŠ é‡è¯•/é”™è¯¯å¤„ç†| E[é«˜å¯ç”¨ç³»ç»Ÿ]
```

### ğŸ“š æ¨èå­¦ä¹ æ­¥éª¤

1. **ç¬¬ä¸€æ­¥**ï¼šè¿è¡ŒåŸä»£ç ï¼Œä¿®æ”¹ `user_input` æµ‹è¯•ä¸åŒåœºæ™¯
   ```python
   user_input = "è®¢å•å·ï¼šORD1234567890ï¼Œå•†å“æœ‰ç‘•ç–µï¼Œè¦æ±‚é€€è´§"
   ```
2. **ç¬¬äºŒæ­¥**ï¼šåˆ é™¤ `re.search` é€»è¾‘ï¼Œ**ä»…ç”¨æ¨¡å‹**ï¼Œè§‚å¯Ÿæ€§èƒ½ä¸‹é™
3. **ç¬¬ä¸‰æ­¥**ï¼šåœ¨ `assess_priority` ä¸­**æ·»åŠ æ–°ç´§æ€¥çº§åˆ«**ï¼ŒéªŒè¯é“¾å¼å¤„ç†
4. **ç¬¬å››æ­¥**ï¼šåœ¨ `generate_reply` ä¸­**å¢åŠ å›å¤é•¿åº¦æ ¡éªŒ**

> ğŸ’¡ **ç»ˆæå»ºè®®**ï¼šå…ˆ**ä¸ä¾èµ–æ¨¡å‹**ï¼Œç”¨ `if-else` å®ç°åŸºç¡€é€»è¾‘ â†’ ç¡®ä¿æµç¨‹å¯ç”¨ï¼Œå†é€æ­¥æ›¿æ¢ä¸ºæ¨¡å‹

---

## äº”ã€æ€»ç»“ï¼šLangChain 1.0 æ ¸å¿ƒæ€æƒ³


| ä»£ç å®è·µ                  | è®¾è®¡æ€æƒ³           | ç”Ÿäº§ä»·å€¼        |
| ------------------------- | ------------------ | --------------- |
| ä¼˜å…ˆæ­£åˆ™ â†’ å†è°ƒæ¨¡å‹      | **æœ€å°åŒ–æ¨¡å‹è°ƒç”¨** | é™ä½ 80% æˆæœ¬   |
| å¼ºåˆ¶è¦æ±‚ JSON æ ¼å¼        | **å¯é¢„æµ‹è¾“å‡º**     | é¿å…ä¸‹æ¸¸å´©æºƒ    |
| ç”¨`RunnableParallel` å¹¶è¡Œ | **æœ€å¤§åŒ–åå**     | å¤„ç†é€Ÿåº¦æå‡ 2x |
| æ·»åŠ `reason` å­—æ®µ         | **å¯è§£é‡Šæ€§**       | äººå·¥å¯å¤æ ¸      |

> **è®°ä½**ï¼šLangChain 1.0 ä¸æ˜¯â€œè®©æ¨¡å‹åšæ‰€æœ‰äº‹â€ï¼Œè€Œæ˜¯**ç”¨æœ€å°æˆæœ¬è®©æ¨¡å‹åšå¯¹çš„äº‹**ã€‚

---

> æœ¬æ–‡ä»£ç å·²é€šè¿‡æµ‹è¯•ï¼Œå¯ç›´æ¥è¿è¡Œã€‚**ç”Ÿäº§ç¯å¢ƒå»ºè®®**ï¼š
>
> 1. æ·»åŠ  `max_tokens` é™åˆ¶ï¼ˆé¿å…é•¿æ–‡æœ¬çˆ†æ ˆï¼‰
> 2. ç”¨ `langchain_community` æ›¿ä»£ `langchain`ï¼ˆæœ€æ–°ç‰ˆï¼‰
> 3. ä¸º `call_qwen_with_retry` æ·»åŠ  **é€Ÿç‡é™åˆ¶**ï¼ˆé¿å… API é™æµï¼‰

> ä»ä»Šå¤©å¼€å§‹ï¼Œ**ç”¨ LangChain 1.0 å†™ä»£ç æ—¶ï¼Œå…ˆé—®è‡ªå·±ï¼šè¿™èƒ½ç”¨æ­£åˆ™/ç®€å•é€»è¾‘è§£å†³å—ï¼Ÿ** âœ…
